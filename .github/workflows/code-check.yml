name: Code Quality Check

on:
  push:
    branches: [main, beta]
  pull_request:
    branches: [main, beta]

jobs:
  syntax-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install streamlit openai requests python-dotenv

      - name: Check Python syntax (all files)
        id: syntax
        run: |
          echo "=== Python Syntax Check ==="
          errors=""
          for file in $(find . -name "*.py" -not -path "./.venv/*" -not -path "./venv/*"); do
            if ! python -m py_compile "$file" 2>&1; then
              errors="$errors\n$file"
            fi
          done
          if [ -n "$errors" ]; then
            echo "SYNTAX_ERRORS<<EOF" >> $GITHUB_OUTPUT
            echo -e "$errors" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "::error::Syntax errors found in:$errors"
            exit 1
          fi
          echo "All files passed syntax check!"

      - name: Check core module imports
        id: imports
        run: |
          echo "=== Import Check ==="
          cd $GITHUB_WORKSPACE
          python << 'EOF'
          import sys
          import importlib.util

          # í•µì‹¬ ëª¨ë“ˆ ëª©ë¡
          core_modules = [
              "config",
              "env_config",
              "api_utils",
              "auth_utils",
              "ui_config",
              "sidebar_common",
          ]

          errors = []
          for module in core_modules:
              try:
                  spec = importlib.util.spec_from_file_location(module, f"{module}.py")
                  if spec and spec.loader:
                      # êµ¬ë¬¸ë§Œ ê²€ì‚¬
                      with open(f"{module}.py", 'r', encoding='utf-8') as f:
                          source = f.read()
                      compile(source, f"{module}.py", 'exec')
                      print(f"âœ“ {module}")
              except FileNotFoundError:
                  print(f"âš  {module} - íŒŒì¼ ì—†ìŒ (ë¬´ì‹œ)")
              except SyntaxError as e:
                  errors.append(f"{module}: Line {e.lineno} - {e.msg}")
                  print(f"âœ— {module}: {e.msg}")
              except Exception as e:
                  errors.append(f"{module}: {str(e)}")
                  print(f"âœ— {module}: {e}")

          if errors:
              print("\n=== ERRORS ===")
              for err in errors:
                  print(err)
              sys.exit(1)

          print("\nAll core modules OK!")
          EOF

      - name: Check page files
        run: |
          echo "=== Page Files Check ==="
          cd $GITHUB_WORKSPACE
          python << 'EOF'
          import sys
          from pathlib import Path

          pages_dir = Path("pages")
          if not pages_dir.exists():
              print("pages/ directory not found")
              sys.exit(0)

          errors = []
          for page_file in sorted(pages_dir.glob("*.py")):
              if page_file.name.startswith("__"):
                  continue
              try:
                  with open(page_file, 'r', encoding='utf-8') as f:
                      source = f.read()
                  compile(source, page_file, 'exec')
                  print(f"âœ“ {page_file.name}")
              except SyntaxError as e:
                  errors.append(f"{page_file.name}: Line {e.lineno} - {e.msg}")
                  print(f"âœ— {page_file.name}: Line {e.lineno} - {e.msg}")

          if errors:
              print(f"\n=== {len(errors)} ERRORS FOUND ===")
              sys.exit(1)

          print(f"\nAll page files OK!")
          EOF

      - name: Check typing imports
        run: |
          echo "=== Typing Import Check ==="
          python << 'EOF'
          import re
          from pathlib import Path

          # typing ê´€ë ¨ íŒ¨í„´ ì°¾ê¸°
          typing_pattern = re.compile(r'\b(List|Dict|Tuple|Optional|Union|Set|Any|Callable)\[')
          import_pattern = re.compile(r'from typing import (.+)')

          issues = []

          for py_file in Path(".").rglob("*.py"):
              if ".venv" in str(py_file) or "venv" in str(py_file):
                  continue

              try:
                  content = py_file.read_text(encoding='utf-8')

                  # ì‚¬ìš©ëœ typing íƒ€ìž… ì°¾ê¸°
                  used_types = set(typing_pattern.findall(content))

                  if used_types:
                      # import ë¬¸ì—ì„œ ê°€ì ¸ì˜¨ íƒ€ìž… ì°¾ê¸°
                      imports = import_pattern.findall(content)
                      imported_types = set()
                      for imp in imports:
                          imported_types.update(t.strip() for t in imp.split(','))

                      # ëˆ„ë½ëœ íƒ€ìž… í™•ì¸
                      missing = used_types - imported_types
                      if missing:
                          issues.append(f"{py_file}: Missing typing imports: {missing}")
              except:
                  pass

          if issues:
              print("=== TYPING IMPORT ISSUES ===")
              for issue in issues:
                  print(f"âš  {issue}")
              # ê²½ê³ ë§Œ ì¶œë ¥, ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
          else:
              print("No typing import issues found!")
          EOF

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âš ï¸ FlyReady Lab ì½”ë“œ ì˜¤ë¥˜ - ${{ github.ref_name }} ë¸Œëžœì¹˜"
          body: |
            ðŸš¨ ì½”ë“œ ê²€ì‚¬ ì‹¤íŒ¨!

            ë¸Œëžœì¹˜: ${{ github.ref_name }}
            ì»¤ë°‹: ${{ github.sha }}
            ìž‘ì„±ìž: ${{ github.actor }}

            ì»¤ë°‹ ë©”ì‹œì§€: ${{ github.event.head_commit.message }}

            ìžì„¸í•œ ë‚´ìš©ì€ GitHub Actionsì—ì„œ í™•ì¸í•˜ì„¸ìš”:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---
            Claude Codeì™€ í•¨ê»˜ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
          to: ${{ secrets.ADMIN_EMAIL }}
          from: FlyReady Lab CI <${{ secrets.SMTP_USER }}>

  json-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check JSON files
        run: |
          echo "=== JSON Validation ==="
          python << 'EOF'
          import json
          import sys
          from pathlib import Path

          data_dir = Path("data")
          if not data_dir.exists():
              print("data/ directory not found")
              sys.exit(0)

          errors = []
          for json_file in data_dir.rglob("*.json"):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      json.load(f)
                  print(f"âœ“ {json_file}")
              except json.JSONDecodeError as e:
                  errors.append(f"{json_file}: {e.msg}")
                  print(f"âœ— {json_file}: {e.msg}")

          if errors:
              print(f"\n=== {len(errors)} JSON ERRORS ===")
              sys.exit(1)

          print("\nAll JSON files valid!")
          EOF
