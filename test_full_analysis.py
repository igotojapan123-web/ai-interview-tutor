# -*- coding: utf-8 -*-
"""
자소서 전체 분석 - 핵심문장 3개 + 서브문장 3개 + 질문 5개
"""

import os
import json
from openai import OpenAI

from dotenv import load_dotenv
load_dotenv()

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

FULL_ANALYSIS_PROMPT = """당신은 항공사 면접관입니다. 지원자의 자기소개서를 심층 분석하여 면접 질문을 준비합니다.

## 자소서 문항
{question}

## 지원자 답변
{answer}

## 분석 지시사항

### 1단계: 문항 의도 파악
이 문항이 지원자의 무엇을 확인하려는지 1-2문장으로 정리하세요.

### 2단계: 핵심문장 3개 선정
문항 의도에 **직접 답하는** 핵심 문장을 답변에서 **정확히 원문 그대로** 추출하세요.

선정 기준:
1. 지원자의 **가치관/신념** (예: "~가 중요하다고 생각합니다")
2. 지원자의 **깨달음/성장** (예: "~을 깨달았습니다", "~할 수 있었습니다")
3. 지원자의 **구체적 행동** (예: "~를 조성하였습니다", "~했습니다")

제외할 것:
- 단순 사실 진술 (예: "16살에 유학을 갔습니다")
- 제목/이름/라벨 (예: "영화 제목은 OOO입니다")
- 문장 조각 (완전한 문장만 선택)

### 3단계: 각 핵심문장의 서브 포인트 3개
각 핵심문장을 뒷받침하거나 구체화하는 문장/표현을 답변에서 찾으세요.
- 핵심문장의 근거가 되는 경험
- 핵심문장을 설명하는 구체적 사례
- 핵심문장과 연결되는 다른 표현

### 4단계: 면접 질문 5개 생성
핵심문장과 서브포인트를 바탕으로 날카로운 면접 질문 5개를 만드세요.

질문 유형:
- 구체화: "구체적으로 어떤 상황이었나요?"
- 검증: "정말 그렇게 하셨나요? 본인 역할은?"
- 한계/반례: "그 방법이 안 통하면 어떻게?"
- 적용: "승무원으로서 이 경험을 어떻게 활용?"
- 심화: "왜 그렇게 생각하셨나요?"

질문 작성 규칙:
- 짧고 직접적으로 (1-2문장)
- "풀어서 말씀해 주세요" 같은 약한 질문 금지
- 지원자가 구체적으로 답할 수밖에 없는 질문

## JSON 출력 형식
{{
  "question_intent": "문항이 확인하려는 핵심",
  "key_sentences": [
    {{
      "sentence": "핵심문장 원문",
      "type": "가치주장/경험깨달음/구체적행동",
      "sub_points": [
        "서브포인트 1",
        "서브포인트 2",
        "서브포인트 3"
      ]
    }}
  ],
  "interview_questions": [
    {{
      "question": "면접 질문",
      "type": "구체화/검증/한계반례/적용/심화",
      "target": "이 질문이 겨냥하는 핵심문장 번호 (1,2,3)"
    }}
  ]
}}
"""

def analyze_resume(question: str, answer: str) -> dict:
    prompt = FULL_ANALYSIS_PROMPT.format(question=question, answer=answer)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": "당신은 항공사 면접관입니다. JSON 형식으로만 응답하세요."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.7,
        response_format={"type": "json_object"}
    )

    return json.loads(response.choices[0].message.content)


def print_analysis(result: dict, title: str):
    print("\n" + "="*70)
    print(f"[{title}]")
    print("="*70)

    print(f"\n[문항 의도]")
    print(f"  {result.get('question_intent', 'N/A')}")

    print(f"\n" + "-"*70)
    print("[핵심문장 + 서브포인트]")
    print("-"*70)

    for i, ks in enumerate(result.get("key_sentences", []), 1):
        print(f"\n  [핵심문장 {i}] ({ks.get('type', '')})")
        print(f"  \"{ks.get('sentence', '')}\"")

        print(f"\n    서브포인트:")
        for j, sub in enumerate(ks.get("sub_points", []), 1):
            print(f"      {j}. {sub}")

    print(f"\n" + "-"*70)
    print("[면접 질문 5개]")
    print("-"*70)

    for i, q in enumerate(result.get("interview_questions", []), 1):
        print(f"\n  Q{i}. [{q.get('type', '')}] (핵심문장 {q.get('target', '')} 관련)")
        print(f"      \"{q.get('question', '')}\"")


if __name__ == "__main__":
    # 문항 1
    question1 = """동료 승무원들이 함께 근무하고 싶어하는 승무원이 되기 위해,
본인이 중요하게 생각하는 것은 무엇이며,
이를 위해 어떤 노력을 하고 있나요?"""

    answer1 = """전반적인 인생에 걸쳐 사람들과 같이 더불어 살 수 밖에 없습니다. 그렇기에 팀워크가 제일 중요하다고 생각합니다.
저는 16살이라는 나이에 중국 칭다오로 홀로 유학을 가게되었습니다.
타국에 홀로 떨어져서 기숙사 생활을 하니 말이 통하지 않는 무서움, 의지할 사람 없이 혼자 헤쳐나가야 한다는 부담감을 처음 느껴봤습니다.
하지만 기숙사에는 저와 같이 가족들과 떨어져서 홀로 유학을 온 사람들이 있었고 이 몇몇 사람들과 저는 함께 중국어 공부를 통해서 중국 생활에 적응하려고 노력했고, 중국어 공부를 비롯해 학교에서 배우는 경제학 수업이나 ACT 수업 등등 서로 부족한 부분을 채워주며 학교 생활도 같이 적응하려고 노력했습니다.
그렇기에 서로 더 의지하며 타지 생활의 외로움을 달랬습니다. 저는 실제로 홀로 중국에 유학을 갔을 때 향수병이 무엇인지 느껴봤고, 극복해본 결과 혼자였으면 절대 극복하지 못할 것들을 공동체 속에 함께 있으니 극복할 수 있었던 경험이 있습니다. 저의 이러한 경험들이 저에게 하여금 사람들과 공동체 속에서 어울릴 때의 가치와 공동체 의식의 중요성 그리고 더불어 살아가는 것이 무엇인지를 깨닫게 해주었습니다.
그래서 저는 많은 운동중에서도 축구라는 스포츠를 제일 선호합니다. 축구라는 스포츠는 11명이서 합을 맞추어 진행되는 스포츠입니다. 11명 중 한명만 정말 특출나게 잘한다고 하더라도 모든 경기에서 승리할 수는 없습니다,
그렇기에 축구에는 팀컬러 라는것이 존재하며 각 팀마다 팀컬러가 다릅니다. 저는 현재 세명대학교 항공서비스학과 축구 동아리 나르샤의 주장으로써 정말 잘하는 강팀을 만든다기 보다는 정말 축구를 잘 하지는 못하지만 좋아하는 인원도 같이 웃으면서 축구경기를 할 수 있는 환경을 조성하였습니다."""

    # 문항 2
    question2 = """자신의 인생을 한 편의 영화로 제작한다면,
어떤 장르와 제목으로 표현하고 싶으며 그 이유는 무엇인가요?"""

    answer2 = """저는 제 안생을 영화로 만든다면, 그 장르는 다큐멘터리일 것입니다,
왜냐하면 지금까지의 제 삶은 화려하거나 극적인 반전이 있는 영화나 드라마라기보다는, 작은 선택과 경험들이 차곡차곡 쌓이며 지금의 저를 만들어온 현실적인 여정의 기록이기 때문입니다. 다큐멘터리같은 제 삶은 한 장면 한 장면이 의미 있는 선택과 성장의 연속이었고, 그것이 저로 하여금 지금 현재의 나를 만들어주었기 때문입니다.
제 영화제목은 《初航：梦想的起点》 (첫 비행: 꿈의 시작점)입니다.
제 인생에서 가장 큰 전환점은 중학생 때의 홀로 떠난 중국 유학 경험이였습니다. 그 당시 혼자 비행기에 올라 낯선 나라로 향하는 비행기에 몸을 실었던 순간, 설렘과 동시에 막연한 두려움도 함께 느꼈습니다. 하지만 매번 비행기를 탈 때마다 승무원 분들의 따뜻한 미소와 승객분들을 향한 섬세한 배려는 저에게 큰 안정감을 주었고, 어느 순간부터 그들의 모습이 제 눈에 하나의 '이상적인 직업'으로 보이기 시작했습니다.
그 이후로 저에게 있어서 비행은 단순한 이동 수단이 아니라, 새로운 환경에 도전하고 성장해가는 여정을 상징하는 경험이 되었습니다. 그 여정 속에서 다양한 문화와 언어를 경험하고, 동시에 넓은 시야와 열린 마음을 가지게 되었습니다. 그리고 자연스럽게 저도 저를 반겨주었던 그 승무원분 처럼 '나도 언젠가 누군가의 첫 여정을 따뜻하게 맞이하는 사람이 되고 싶다'는 꿈을 품게 되었습니다.
이 영화는 저의 성장과 변화, 그리고 꿈을 향한 노력의 과정을 진솔하게 담은 하나의 다큐멘터리 입니다. 그리고 지금 저는 그 다음 장면, 바로 하늘 위에서 고객의 안전과 편안함을 책임지는 승무원으로서의 새로운 장을 준비하고 있습니다. 이 다큐멘터리가 계속될 수 있도록 , 저는 앞으로도 끊임없이 배우고 도전하며, 누군가의 여행에 따뜻한 기억을 남겨줄 수 있는 그런 승무원이 되고싶습니다."""

    print("\n" + "#"*70)
    print("# 자소서 전체 분석 결과")
    print("#"*70)

    result1 = analyze_resume(question1, answer1)
    print_analysis(result1, "문항 1: 팀워크")

    result2 = analyze_resume(question2, answer2)
    print_analysis(result2, "문항 2: 영화 장르")
